#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Created on Sun Nov 16 11:38:01 2025

@author: hannahcarroll
"""
import numpy as np
import sounddevice as sd
import time
import json
from arduino_reader import ArduinoReader

### CONFIGURATION 
FS = 44100
THRESHOLDS = [825, 860, 950, 800]
GAIT_CYCLE_FILE = "average_gait_cycle.json"

### "Average" Sound Audio Generation 

def generate_average_gait_sound(period, offsets, freqs):
    t = np.linspace(0, period, int(period * FS), endpoint=False)
    audio = np.zeros_like(t)

    # Heel at time 0
    audio += 0.3 * np.sin(2 * np.pi * freqs[0] * t)

    # Other sensors at offsets
    for sensor, offset in offsets.items():
        start_idx = int(offset * FS)
        if start_idx < len(t):
            wav = 0.3 * np.sin(2 * np.pi * freqs[sensor] * t[:len(t)-start_idx])
            audio[start_idx:start_idx+len(wav)] += wav

    return audio.astype(np.float32)

### Stutter + Normal Gait Detection 

def detect_stutter(fsr_values):
    """True if toeâ†’toe without heel between."""
    detect_stutter.state = getattr(detect_stutter, "state", 0)
    heel = fsr_values[0] > THRESHOLDS[0]
    toe = fsr_values[1] > THRESHOLDS[1]
    
    if detect_stutter.state == 0 and toe and not heel:
        detect_stutter.state = 1
    elif detect_stutter.state == 1 and not toe:
        detect_stutter.state = 2
    elif detect_stutter.state == 2 and toe and not heel:
        detect_stutter.state = 0
        return True
    elif heel:
        detect_stutter.state = 0  # reset if heel lands
    return False

def detect_heelstrike(fsr_values):
    """True if heel sensor (sensor 0) is pressed (heelstrike)."""
    return fsr_values[0] > THRESHOLDS[0]

### Main Monitoring Loop 

def gait_stutter_monitor(port='/dev/cu.usbserial-110', baud=9600):
    with open(GAIT_CYCLE_FILE, 'r') as f:
        gait = json.load(f)
    period, offsets = gait['period'], {int(k): v for k, v in gait['offsets'].items()}
    freqs = [261.63, 329.63, 392.00, 493.88]

    avg_sound = generate_average_gait_sound(period, offsets, freqs)

    reader = ArduinoReader(port=port, baud=baud)

    playing_loop = False

    try:
        while True:
            data = reader.get_data()
            if data is None:
                continue

            if not playing_loop and detect_stutter(data):
                sd.play(avg_sound, FS, loop=True)
                playing_loop = True

            if playing_loop and detect_heelstrike(data):
                sd.stop()
                playing_loop = False

            time.sleep(0.01)

    finally:
        reader.stop()
        sd.stop()

# Run script
if __name__ == "__main__":
    gait_stutter_monitor()
